---
// src/components/CookieConsent.astro
// Cookie consent component for GDPR/CCPA compliance
---

<!-- Load CookieConsent CSS asynchronously to prevent render blocking -->
<link rel="preload" href="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@3.1.0/dist/cookieconsent.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@3.1.0/dist/cookieconsent.css"></noscript>

<script is:inline>
  // Lazy load CookieConsent after page is fully loaded
  function loadCookieConsent() {
    // Check if already loaded
    if (window.cookieConsentLoaded) return;
    window.cookieConsentLoaded = true;

    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@3.1.0/dist/cookieconsent.umd.js';
    script.onload = function() {
      initCookieConsent();
    };
    document.head.appendChild(script);
  }

  function initCookieConsent() {
    if (!window.CookieConsent) {
      console.error('CookieConsent library not loaded');
      return;
    }

    window.CookieConsent.run({
    guiOptions: {
      consentModal: {
        layout: 'box',
        position: 'bottom right'
      },
      preferencesModal: {
        layout: 'box'
      }
    },
    
    categories: {
      necessary: {
        enabled: true,
        readOnly: true
      },
      
      analytics: {
        enabled: false,
        readOnly: false,
        
        services: {
          ga4: {
            label: 'Google Analytics 4',
            cookies: [
              {
                name: '_ga',
                domain: 'akrade.com',
                description: 'Used to distinguish users',
                expiration: '2 years'
              },
              {
                name: '_gid',
                domain: 'akrade.com',
                description: 'Used to distinguish users',
                expiration: '24 hours'
              },
              {
                name: '_gat',
                domain: 'akrade.com',
                description: 'Used to throttle request rate',
                expiration: '1 minute'
              },
              {
                name: '_ga_<container-id>',
                domain: 'akrade.com',
                description: 'Used to persist session state',
                expiration: '2 years'
              },
              {
                name: '__utma',
                domain: 'akrade.com',
                description: 'Used to distinguish users and sessions',
                expiration: '2 years'
              },
              {
                name: '__utmb',
                domain: 'akrade.com',
                description: 'Used to determine new sessions/visits',
                expiration: '30 minutes'
              },
              {
                name: '__utmc',
                domain: 'akrade.com',
                description: 'Used to determine new sessions/visits',
                expiration: 'Session'
              },
              {
                name: '__utmz',
                domain: 'akrade.com',
                description: 'Stores traffic source or campaign',
                expiration: '6 months'
              }
            ]
          },
          
          clarity: {
            label: 'Microsoft Clarity',
            cookies: [
              {
                name: '_clck',
                domain: 'akrade.com',
                description: 'Persists Clarity User ID and preferences',
                expiration: '1 year'
              },
              {
                name: '_clsk',
                domain: 'akrade.com',
                description: 'Connects multiple page views in a session',
                expiration: '1 day'
              },
              {
                name: 'CLID',
                domain: 'akrade.com',
                description: 'Identifies first-time visitors',
                expiration: '1 year'
              },
              {
                name: 'ANONCHK',
                domain: '.clarity.ms',
                description: 'Indicates whether user is new or returning',
                expiration: '10 minutes'
              },
              {
                name: 'MR',
                domain: '.clarity.ms',
                description: 'Indicates whether to refresh MUID',
                expiration: '7 days'
              },
              {
                name: 'MUID',
                domain: '.clarity.ms',
                description: 'Identifies unique web browsers',
                expiration: '1 year'
              },
              {
                name: 'SM',
                domain: '.clarity.ms',
                description: 'Synchronizes MUID across domains',
                expiration: 'Session'
              }
            ]
          },
          
          gtm: {
            label: 'Google Tag Manager',
            cookies: [
              {
                name: '_gcl_au',
                domain: 'akrade.com',
                description: 'Used by Google AdSense for experiments',
                expiration: '3 months'
              }
            ]
          }
        }
      }
    },
    
    language: {
      default: 'en',
      translations: {
        en: {
          consentModal: {
            title: 'We use cookies',
            description: 'We use cookies to improve your experience. You can choose to opt in or out of each category at any time.',
            acceptAllBtn: 'Accept all',
            acceptNecessaryBtn: 'Reject all',
            showPreferencesBtn: 'Manage preferences'
          },
          preferencesModal: {
            title: 'Cookie Preferences Center',
            acceptAllBtn: 'Accept all',
            acceptNecessaryBtn: 'Reject all',
            savePreferencesBtn: 'Save preferences',
            sections: [
              {
                title: 'Strictly Necessary Cookies',
                description: 'These cookies are essential for the website to function and cannot be disabled.',
                linkedCategory: 'necessary'
              },
              {
                title: 'Analytics Cookies',
                description: 'These cookies help us understand how visitors interact with our website by collecting and reporting information anonymously.',
                linkedCategory: 'analytics'
              }
            ]
          }
        }
      }
    }
  });
  }

  // Load cookie consent when page is idle (after initial load)
  if ('requestIdleCallback' in window) {
    // Use requestIdleCallback for better performance
    requestIdleCallback(loadCookieConsent, { timeout: 2000 });
  } else {
    // Fallback for browsers without requestIdleCallback
    window.addEventListener('load', function() {
      setTimeout(loadCookieConsent, 1000);
    });
  }
</script>