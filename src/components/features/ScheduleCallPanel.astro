---
import { SlidePanel } from '../../packages/slide-panel';
---

<SlidePanel id="schedule-call" title="Schedule a Meeting">
  <!-- Cal.com embed -->
  <div class="cal-embed-container">
    <iframe
      width="100%"
      height="100%"
      allow="camera; microphone; autoplay; encrypted-media;"
      title="Schedule a meeting with AkradÃ©"
      id="calEmbed"
      loading="lazy"
    ></iframe>
  </div>
</SlidePanel>

<style>
  /* Cal.com embed container */
  .cal-embed-container {
    flex: 1;
    min-height: 600px;
    background: var(--color-bg-elevated);
    border-radius: 8px;
    overflow: hidden;
    position: relative;

    iframe {
      border: none;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.3s ease;

      &.loaded {
        opacity: 1;
      }
    }

    @media (max-width: 768px) {
      min-height: 500px;
    }
  }
</style>

<script>
  import { initSlidePanel } from '../../packages/slide-panel';

  // Track cleanup functions and observers
  let panelInstance: ReturnType<typeof initSlidePanel> | null = null;
  let themeObserver: MutationObserver | null = null;

  function initSchedulePanel() {
    // Cleanup existing instance
    if (panelInstance) {
      panelInstance.cleanup();
      panelInstance = null;
    }
    if (themeObserver) {
      themeObserver.disconnect();
      themeObserver = null;
    }

    const calIframe = document.getElementById('calEmbed') as HTMLIFrameElement | null;
    if (!calIframe) return;

    // Load cal.com iframe with correct theme (lazy load on first open)
    function loadCalWithTheme() {
      if (!calIframe) return;
      // Check if iframe already has content loaded
      if (calIframe.src && calIframe.src !== 'about:blank') return;

      const htmlElement = document.documentElement;
      const currentTheme = htmlElement.getAttribute('data-theme') || 'dark';
      const baseUrl = 'https://cal.com/akrade';

      // Remove loaded class before loading new content
      calIframe.classList.remove('loaded');

      // Listen for iframe load event to fade it in
      const loadHandler = () => {
        if (!calIframe) return;
        calIframe.classList.add('loaded');
        calIframe.removeEventListener('load', loadHandler);
      };
      calIframe.addEventListener('load', loadHandler);

      // Load iframe with theme parameter
      calIframe.src = `${baseUrl}?theme=${currentTheme}`;
    }

    // Update cal.com iframe theme (only if already loaded)
    function updateCalTheme() {
      if (!calIframe) return;
      // Only update if iframe already has content loaded
      if (!calIframe.src || calIframe.src === 'about:blank') return;

      const htmlElement = document.documentElement;
      const currentTheme = htmlElement.getAttribute('data-theme') || 'dark';
      const baseUrl = 'https://cal.com/akrade';

      // Remove loaded class before reloading with new theme
      calIframe.classList.remove('loaded');

      // Listen for iframe load event to fade it in
      const loadHandler = () => {
        if (!calIframe) return;
        calIframe.classList.add('loaded');
        calIframe.removeEventListener('load', loadHandler);
      };
      calIframe.addEventListener('load', loadHandler);

      // Update iframe src with theme parameter
      calIframe.src = `${baseUrl}?theme=${currentTheme}`;
    }

    // Initialize the slide panel with callbacks
    panelInstance = initSlidePanel({
      panelId: 'schedule-call-panel',
      backdropId: 'schedule-call-backdrop',
      closeButtonId: 'schedule-call-close-button',
      onOpen: loadCalWithTheme,
    });

    // Watch for theme changes and update cal.com
    themeObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'data-theme') {
          updateCalTheme();
        }
      });
    });

    themeObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-theme'],
    });

    // Expose functions globally with legacy names for backward compatibility
    window.openScheduleCall = panelInstance.open;
    window.closeScheduleCall = panelInstance.close;
    // Also expose with legacy names
    window.openSchedulePanel = panelInstance.open;
    window.closeSchedulePanel = panelInstance.close;
  }

  // Initialize immediately on first load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSchedulePanel);
  } else {
    initSchedulePanel();
  }

  // Re-initialize after View Transitions navigation
  document.addEventListener('astro:page-load', initSchedulePanel);

  // Cleanup before navigation
  document.addEventListener('astro:before-preparation', () => {
    if (panelInstance) {
      panelInstance.cleanup();
      panelInstance = null;
    }
    if (themeObserver) {
      themeObserver.disconnect();
      themeObserver = null;
    }
  });
</script>
